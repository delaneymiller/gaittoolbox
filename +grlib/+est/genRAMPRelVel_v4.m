%manually differentiated PJC, using vector form rather than trigonometric 
%avoids acos singularity

wxRFEM = wxRTIB*(4*(q1RFEM*q4RFEM+q2RFEM*q3RFEM)*(q1RTIB*q4RTIB+q2RTIB*q3RTIB)+4*(q1RFEM*q3RFEM-q2RFEM*q4RFEM)*(q1RTIB*q3RTIB-q2RTIB*q4RTIB)+(-1+2*q1RFEM^2+2*q2RFEM^2)*(-1+2*q1RTIB^2+2*q2RTIB^2)) + 2*wyRTIB*((q1RFEM*q4RFEM+q2RFEM*q3RFEM)*(-1+2*q1RTIB^2+2*q3RTIB^2)-2*(q1RTIB*q2RTIB+q3RTIB*q4RTIB)*(q1RFEM*q3RFEM-q2RFEM*q4RFEM)-(q1RTIB*q4RTIB-q2RTIB*q3RTIB)*(-1+2*q1RFEM^2+2*q2RFEM^2)) + 2*wzRTIB*((q1RTIB*q3RTIB+q2RTIB*q4RTIB)*(-1+2*q1RFEM^2+2*q2RFEM^2)-2*(q1RFEM*q4RFEM+q2RFEM*q3RFEM)*(q1RTIB*q2RTIB-q3RTIB*q4RTIB)-(q1RFEM*q3RFEM-q2RFEM*q4RFEM)*(-1+2*q1RTIB^2+2*q4RTIB^2));

wzRFEM = wzRTIB*(4*(q1RFEM*q3RFEM+q2RFEM*q4RFEM)*(q1RTIB*q3RTIB+q2RTIB*q4RTIB)+4*(q1RFEM*q2RFEM-q3RFEM*q4RFEM)*(q1RTIB*q2RTIB-q3RTIB*q4RTIB)+(-1+2*q1RFEM^2+2*q4RFEM^2)*(-1+2*q1RTIB^2+2*q4RTIB^2)) + 2*wxRTIB*((q1RFEM*q3RFEM+q2RFEM*q4RFEM)*(-1+2*q1RTIB^2+2*q2RTIB^2)-2*(q1RTIB*q4RTIB+q2RTIB*q3RTIB)*(q1RFEM*q2RFEM-q3RFEM*q4RFEM)-(q1RTIB*q3RTIB-q2RTIB*q4RTIB)*(-1+2*q1RFEM^2+2*q4RFEM^2)) + 2*wyRTIB*((q1RTIB*q2RTIB+q3RTIB*q4RTIB)*(-1+2*q1RFEM^2+2*q4RFEM^2)-2*(q1RFEM*q3RFEM+q2RFEM*q4RFEM)*(q1RTIB*q4RTIB-q2RTIB*q3RTIB)-(q1RFEM*q2RFEM-q3RFEM*q4RFEM)*(-1+2*q1RTIB^2+2*q3RTIB^2));

wyRFEM = 2*wxRFEM*((q1RTIB*q4RTIB+q2RTIB*q3RTIB)*(-1+2*q1RFEM^2+2*q3RFEM^2)-2*(q1RFEM*q2RFEM+q3RFEM*q4RFEM)*(q1RTIB*q3RTIB-q2RTIB*q4RTIB)-(q1RFEM*q4RFEM-q2RFEM*q3RFEM)*(-1+2*q1RTIB^2+2*q2RTIB^2))/(4*(q1RFEM*q4RFEM+q2RFEM*q3RFEM)*(q1RTIB*q4RTIB+q2RTIB*q3RTIB)+4*(q1RFEM*q3RFEM-q2RFEM*q4RFEM)*(q1RTIB*q3RTIB-q2RTIB*q4RTIB)+(-1+2*q1RFEM^2+2*q2RFEM^2)*(-1+2*q1RTIB^2+2*q2RTIB^2));

qRKN_dot = wyRTIB - wyRFEM;

relVel_RANK_PELo_N = [(0.5*d_pelvis*wzPEL*(-1+2*q1PEL^2+2*q2PEL^2)-d_pelvis*wxPEL*(q1PEL*q3PEL+q2PEL*q4PEL)-2*(q1RTIB*q4RTIB-q2RTIB*q3RTIB)*(d_rfemur*wzRTIB*sin(qRKN)+wxRTIB*(d_rtibia+d_rfemur*cos(qRKN)))-2*d_rfemur*sin(qRKN)*(q1RTIB*q3RTIB+q2RTIB*q4RTIB)*(wyRTIB-qRKN_dot)-(-1+2*q1RTIB^2+2*q2RTIB^2)*(wyRTIB*(d_rtibia+d_rfemur*cos(qRKN))-d_rfemur*cos(qRKN)*qRKN_dot)); (d_pelvis*wzPEL*(q1PEL*q4PEL+q2PEL*q3PEL)+d_pelvis*wxPEL*(q1PEL*q2PEL-q3PEL*q4PEL)+(-1+2*q1RTIB^2+2*q3RTIB^2)*(d_rfemur*wzRTIB*sin(qRKN)+wxRTIB*(d_rtibia+d_rfemur*cos(qRKN)))+2*d_rfemur*sin(qRKN)*(q1RTIB*q2RTIB-q3RTIB*q4RTIB)*(wyRTIB-qRKN_dot)-2*(q1RTIB*q4RTIB+q2RTIB*q3RTIB)*(wyRTIB*(d_rtibia+d_rfemur*cos(qRKN))-d_rfemur*cos(qRKN)*qRKN_dot)); (2*(q1RTIB*q2RTIB+q3RTIB*q4RTIB)*(d_rfemur*wzRTIB*sin(qRKN)+wxRTIB*(d_rtibia+d_rfemur*cos(qRKN)))+2*(q1RTIB*q3RTIB-q2RTIB*q4RTIB)*(wyRTIB*(d_rtibia+d_rfemur*cos(qRKN))-d_rfemur*cos(qRKN)*qRKN_dot)-d_pelvis*wzPEL*(q1PEL*q3PEL-q2PEL*q4PEL)-0.5*d_pelvis*wxPEL*(-1+2*q1PEL^2+2*q4PEL^2)-d_rfemur*sin(qRKN)*(-1+2*q1RTIB^2+2*q4RTIB^2)*(wyRTIB-qRKN_dot))];