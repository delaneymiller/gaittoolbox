%manually differentiated PJC, using vector form rather than trigonometric 
%avoids acos singularity

wxLFEM = wxLTIB*(4*(q1LFEM*q4LFEM+q2LFEM*q3LFEM)*(q1LTIB*q4LTIB+q2LTIB*q3LTIB)+4*(q1LFEM*q3LFEM-q2LFEM*q4LFEM)*(q1LTIB*q3LTIB-q2LTIB*q4LTIB)+(-1+2*q1LFEM^2+2*q2LFEM^2)*(-1+2*q1LTIB^2+2*q2LTIB^2)) + 2*wyLTIB*((q1LFEM*q4LFEM+q2LFEM*q3LFEM)*(-1+2*q1LTIB^2+2*q3LTIB^2)-2*(q1LTIB*q2LTIB+q3LTIB*q4LTIB)*(q1LFEM*q3LFEM-q2LFEM*q4LFEM)-(q1LTIB*q4LTIB-q2LTIB*q3LTIB)*(-1+2*q1LFEM^2+2*q2LFEM^2)) + 2*wzLTIB*((q1LTIB*q3LTIB+q2LTIB*q4LTIB)*(-1+2*q1LFEM^2+2*q2LFEM^2)-2*(q1LFEM*q4LFEM+q2LFEM*q3LFEM)*(q1LTIB*q2LTIB-q3LTIB*q4LTIB)-(q1LFEM*q3LFEM-q2LFEM*q4LFEM)*(-1+2*q1LTIB^2+2*q4LTIB^2));

wzLFEM = wzLTIB*(4*(q1LFEM*q3LFEM+q2LFEM*q4LFEM)*(q1LTIB*q3LTIB+q2LTIB*q4LTIB)+4*(q1LFEM*q2LFEM-q3LFEM*q4LFEM)*(q1LTIB*q2LTIB-q3LTIB*q4LTIB)+(-1+2*q1LFEM^2+2*q4LFEM^2)*(-1+2*q1LTIB^2+2*q4LTIB^2)) + 2*wxLTIB*((q1LFEM*q3LFEM+q2LFEM*q4LFEM)*(-1+2*q1LTIB^2+2*q2LTIB^2)-2*(q1LTIB*q4LTIB+q2LTIB*q3LTIB)*(q1LFEM*q2LFEM-q3LFEM*q4LFEM)-(q1LTIB*q3LTIB-q2LTIB*q4LTIB)*(-1+2*q1LFEM^2+2*q4LFEM^2)) + 2*wyLTIB*((q1LTIB*q2LTIB+q3LTIB*q4LTIB)*(-1+2*q1LFEM^2+2*q4LFEM^2)-2*(q1LFEM*q3LFEM+q2LFEM*q4LFEM)*(q1LTIB*q4LTIB-q2LTIB*q3LTIB)-(q1LFEM*q2LFEM-q3LFEM*q4LFEM)*(-1+2*q1LTIB^2+2*q3LTIB^2));

wyLFEM = 2*wxLFEM*((q1LTIB*q4LTIB+q2LTIB*q3LTIB)*(-1+2*q1LFEM^2+2*q3LFEM^2)-2*(q1LFEM*q2LFEM+q3LFEM*q4LFEM)*(q1LTIB*q3LTIB-q2LTIB*q4LTIB)-(q1LFEM*q4LFEM-q2LFEM*q3LFEM)*(-1+2*q1LTIB^2+2*q2LTIB^2))/(4*(q1LFEM*q4LFEM+q2LFEM*q3LFEM)*(q1LTIB*q4LTIB+q2LTIB*q3LTIB)+4*(q1LFEM*q3LFEM-q2LFEM*q4LFEM)*(q1LTIB*q3LTIB-q2LTIB*q4LTIB)+(-1+2*q1LFEM^2+2*q2LFEM^2)*(-1+2*q1LTIB^2+2*q2LTIB^2));

qLKN_dot = wyLTIB - wyLFEM;

relVel_LANK_PELo_N = [(d_pelvis*wxPEL*(q1PEL*q3PEL+q2PEL*q4PEL)-0.5*d_pelvis*wzPEL*(-1+2*q1PEL^2+2*q2PEL^2)-2*(q1LTIB*q4LTIB-q2LTIB*q3LTIB)*(d_lfemur*wzLTIB*sin(qLKN)+wxLTIB*(d_ltibia+d_lfemur*cos(qLKN)))-2*d_lfemur*sin(qLKN)*(q1LTIB*q3LTIB+q2LTIB*q4LTIB)*(wyLTIB-qLKN_dot)-(-1+2*q1LTIB^2+2*q2LTIB^2)*(wyLTIB*(d_ltibia+d_lfemur*cos(qLKN))-d_lfemur*cos(qLKN)*qLKN_dot)); ((-1+2*q1LTIB^2+2*q3LTIB^2)*(d_lfemur*wzLTIB*sin(qLKN)+wxLTIB*(d_ltibia+d_lfemur*cos(qLKN)))+2*d_lfemur*sin(qLKN)*(q1LTIB*q2LTIB-q3LTIB*q4LTIB)*(wyLTIB-qLKN_dot)-d_pelvis*wzPEL*(q1PEL*q4PEL+q2PEL*q3PEL)-d_pelvis*wxPEL*(q1PEL*q2PEL-q3PEL*q4PEL)-2*(q1LTIB*q4LTIB+q2LTIB*q3LTIB)*(wyLTIB*(d_ltibia+d_lfemur*cos(qLKN))-d_lfemur*cos(qLKN)*qLKN_dot)); (d_pelvis*wzPEL*(q1PEL*q3PEL-q2PEL*q4PEL)+0.5*d_pelvis*wxPEL*(-1+2*q1PEL^2+2*q4PEL^2)+2*(q1LTIB*q2LTIB+q3LTIB*q4LTIB)*(d_lfemur*wzLTIB*sin(qLKN)+wxLTIB*(d_ltibia+d_lfemur*cos(qLKN)))+2*(q1LTIB*q3LTIB-q2LTIB*q4LTIB)*(wyLTIB*(d_ltibia+d_lfemur*cos(qLKN))-d_lfemur*cos(qLKN)*qLKN_dot)-d_lfemur*sin(qLKN)*(-1+2*q1LTIB^2+2*q4LTIB^2)*(wyLTIB-qLKN_dot))];